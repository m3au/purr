#!/bin/sh

set -eu

VERSION="0.0.1"
PURR_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/purr"
SHELL_RC="${HOME}/.$(basename "${SHELL:-zsh}")rc"
RELEASE_URL="https://github.com/m3au/purr/releases/download/v${VERSION}/purr-${VERSION}.tar.gz"
QUIET=${QUIET:-0}
PURR_TEST=${PURR_TEST:-0}

log() {
    _level=$1; shift
    _msg="$*"
    _timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    if [ "$PURR_TEST" = "1" ]; then
        printf "%s [%s] %s\n" "$_timestamp" "$_level" "$_msg" >&2
        return
    fi

    if [ "$QUIET" = "1" ]; then
        return 0
    fi

    case "$_level" in
        INFO)  printf "%s [%s] %s\n" "$_timestamp" "$_level" "$_msg" ;;
        WARN)  printf "%s [%s] %s\n" "$_timestamp" "$_level" "$_msg" >&2 ;;
        ERROR) printf "%s [%s] %s\n" "$_timestamp" "$_level" "$_msg" >&2 ;;
    esac
}

cleanup() {
    if [ -d "${TMP_DIR:-}" ]; then
        rm -rf "$TMP_DIR"
    fi
}

check_deps() {
    if ! command -v curl >/dev/null 2>&1; then
        if ! command -v wget >/dev/null 2>&1; then
            log ERROR "curl or wget is required but neither is installed"
            exit 1
        fi
    fi
}

check_shell() {
    case "${SHELL:-}" in
        *zsh|*bash) return 0 ;;
        *) log ERROR "Unsupported shell: ${SHELL:-unknown}"; exit 1 ;;
    esac
}

download_release() {
    _dl_url="$1"
    _dl_output="$2"

    if command -v curl >/dev/null 2>&1; then
        curl -sSL "$_dl_url" -o "$_dl_output"
    else
        wget -q "$_dl_url" -O "$_dl_output"
    fi
}

if [ "${1:-}" = "uninstall" ]; then
    if [ -d "$PURR_DATA_DIR" ]; then
        log INFO "Uninstalling purr..."
        rm -rf "$PURR_DATA_DIR"
        sed -i.bak "/purr._purr/d" "$SHELL_RC"
        log INFO "Uninstallation complete"
    else
        log WARN "purr is not installed"
    fi
    exit 0
fi

main() {
    log INFO "Installing purr v${VERSION}..."

    check_deps
    check_shell

    if [ -d "$PURR_DATA_DIR" ]; then
        log ERROR "Existing installation found at $PURR_DATA_DIR"
        log ERROR "To reinstall, first run: $0 uninstall"
        exit 1
    fi

    TMP_DIR=$(mktemp -d)
    trap cleanup EXIT

    if [ -d "src" ] && [ -f "src/bin/purr" ]; then
        log INFO "Using local source files..."
        mkdir -p "$TMP_DIR/src"
        cp -r src/* "$TMP_DIR/src/"
    elif [ "$PURR_TEST" = "1" ] && [ -f "tests/dev/dist/purr-test.tar.gz" ]; then
        log INFO "Using test distribution..."
        cd "$TMP_DIR"
        tar xzf "$PURR_ROOT/tests/dev/dist/purr-test.tar.gz"
        cd "purr-test"
    else
        log INFO "Downloading purr v${VERSION}..."
        ARCHIVE="$TMP_DIR/purr.tar.gz"
        if ! download_release "$RELEASE_URL" "$ARCHIVE"; then
            log ERROR "Failed to download release"
            exit 1
        fi

        cd "$TMP_DIR"
        if ! tar xzf "$ARCHIVE"; then
            log ERROR "Failed to extract release archive"
            exit 1
        fi
        cd "purr-${VERSION}"
    fi

    log INFO "Installing files..."
    mkdir -p "$PURR_DATA_DIR"

    chmod 755 "$PURR_DATA_DIR"

    cp -rp "$TMP_DIR/src/"* "$PURR_DATA_DIR/"

    find "$PURR_DATA_DIR" -type d -exec chmod 755 {} \;
    find "$PURR_DATA_DIR" -type f -exec chmod 644 {} \;
    chmod 755 "$PURR_DATA_DIR/bin/purr"

    log INFO "Setting up shell integration..."
    {
        echo "# purr shell integration"
        echo "export PURR_ROOT=\"\${XDG_DATA_HOME:-\$HOME/.local/share}/purr\""
        echo "export PURR_LIB=\"\$PURR_ROOT/lib\""
        echo "export PATH=\"\$PURR_ROOT/bin:\$PATH\""
    } > "$PURR_DATA_DIR/_purr"
    chmod 644 "$PURR_DATA_DIR/_purr"

    if ! grep -q "source.*purr/_purr" "$SHELL_RC"; then
        echo "source \"\${XDG_DATA_HOME:-\$HOME/.local/share}/purr/_purr\"" >> "$SHELL_RC"
    fi

    if [ ! -x "$PURR_DATA_DIR/bin/purr" ]; then
        log ERROR "Installation verification failed - executable not found"
        exit 1
    fi

    if [ ! -f "$PURR_DATA_DIR/_purr" ]; then
        log ERROR "Installation verification failed - shell integration not found"
        exit 1
    fi

    log INFO "âœ¨ Installation complete!"
    log INFO "Please restart your shell or run: source $SHELL_RC"
}

main "$@"
