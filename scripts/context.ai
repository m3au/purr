#!/bin/sh

# Create docs directory if it doesn't exist
mkdir -p docs

# Write output to context.md
{
    echo "# Project Context"
    echo "Generated: $(date)"
    echo

    # Collect TODOs from source files
    find . -type f -not -path "*/\.*" -not -path "*/node_modules/*" -exec grep -l "TODO\|FIXME\|XXX" {} \; | while read -r file; do
        if [ -f "$file" ]; then
            echo "## $(basename "$file")"
            grep -h "TODO\|FIXME\|XXX" "$file" | sed 's/^.*TODO/- [ ]/' | sed 's/^.*FIXME/- [ ]/' | sed 's/^.*XXX/- [ ]/'
            echo
        fi
    done

    # Add notes section
    echo "## Notes"
    echo "- Remember to maintain test coverage while developing"
    echo "- Keep security as top priority"
    echo "- Document all shell compatibility issues"
    echo "- Track performance impacts"
    echo "- Keep installation footprint minimal"
    echo

    # Add environment variables
    echo "## Environment Variables"
    echo "Core:"
    if ! grep -h "^[[:space:]]*export[[:space:]]\+PURR_" src/lib/core/*.sh 2>/dev/null | sed 's/^.*export //' | sed 's/=.*//' | sort -u | while read -r var; do
        echo "- $var"
    done; then
        echo "No environment variables defined yet"
    fi
    echo
    echo "Runtime:"
    echo "- SSH_AUTH_SOCK: SSH agent socket"
    echo "- GPG_TTY: GPG terminal"
    echo "- SHELL: User's shell"
    echo

    # Add dependencies
    echo "## Dependencies"
    echo "Required:"
    if ! grep -h "^[[:space:]]*check_dependency" src/lib/commands/system/verify.sh 2>/dev/null | sed 's/.*check_dependency "\([^"]*\)".*/- \1/'; then
        echo "- Dependencies not defined yet"
    fi
    echo
    echo "Optional:"
    if ! grep -h "^[[:space:]]*optional_dependency" src/lib/commands/system/verify.sh 2>/dev/null | sed 's/.*optional_dependency "\([^"]*\)".*/- \1/'; then
        echo "- Optional dependencies not defined yet"
    fi

} > docs/context.md

# Print success message
echo "âœ“ Generated context.md"
